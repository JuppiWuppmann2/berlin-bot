name: Bluesky Bot
on:
  schedule:
    - cron: "*/10 * * * *"  # Alle 10 Minuten
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 8  # Reduziert von 10 auf 8 Minuten
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 1
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # Vereinfachte Chrome-Installation
      - name: Setup Chrome and ChromeDriver
        run: |
          # Chrome installieren
          wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable xvfb
          
          # Chrome-Version prüfen
          CHROME_VERSION=$(google-chrome --version | awk '{print $3}')
          echo "Chrome Version: $CHROME_VERSION"
          
          # ChromeDriver über webdriver-manager herunterladen lassen
          # (wird automatisch beim ersten Start gemacht)
          echo "ChromeDriver wird beim Bot-Start automatisch heruntergeladen"
      
      - name: Run bot with timeout
        timeout-minutes: 6  # Timeout für den Bot selbst
        run: |
          # Virtual display
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          
          # Bot ausführen
          python bot.py
        env:
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_PASSWORD: ${{ secrets.BLUESKY_PASSWORD }}
          PYTHONUNBUFFERED: 1
      
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Letzte 50 Zeilen der Logs ==="
          tail -50 /tmp/*.log 2>/dev/null || echo "Keine Logs verfügbar"
          echo "=== Prozesse ==="
          ps aux | grep -E 'chrome|python' | head -20
      
      - name: Commit and push updated state
        if: always()  # Auch bei Fehlern State speichern
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet data.json; then
            echo "Keine Änderungen in data.json"
          else
            echo "Änderungen in data.json gefunden"
            git add data.json
            
            if [ -f data_backup.json ]; then
              git add data_backup.json
            fi
            
            TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
            git commit -m "Update state - $TIMESTAMP [skip ci]"
            
            # Push mit Retry
            for i in {1..3}; do
              if git push origin HEAD:main; then
                echo "✅ Push erfolgreich"
                break
              else
                echo "⚠️ Push fehlgeschlagen (Versuch $i/3)"
                sleep 3
              fi
            done
          fi
      
      - name: Cleanup
        if: always()
        run: |
          pkill -f chrome || true
          pkill -f Xvfb || true
          rm -rf /tmp/.org.chromium.* 2>/dev/null || true
