name: Bluesky Bot
on:
  schedule:
    - cron: "*/10 * * * *"   # alle 10 Minuten (statt 5, um Rate-Limits zu vermeiden)
  workflow_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 15  # Timeout nach 15 Minuten
    
    steps:
      # Repo auschecken mit Schreibrechten durch GH_PAT
      - uses: actions/checkout@v4  # Aktuellere Version
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 1  # Shallow clone für bessere Performance
      
      # Python einrichten
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: 'pip'  # Pip-Cache für schnellere Builds
      
      # Dependencies installieren aus requirements.txt
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      # Chrome und ChromeDriver für bessere Stabilität vorbereiten
      - name: Setup Chrome and ChromeDriver
        run: |
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable xvfb jq
          
          # Chrome-Version überprüfen
          CHROME_VERSION=$(google-chrome --version | cut -d ' ' -f3)
          echo "Chrome Version: $CHROME_VERSION"
          
          # ChromeDriver über neue Chrome for Testing API installieren
          # Bekannte stabile Versionen als Fallback
          declare -a STABLE_VERSIONS=(
            "129.0.6668.70"
            "128.0.6613.137"
            "127.0.6533.119"
            "126.0.6478.182"
          )
          
          CHROMEDRIVER_URL=""
          
          # Versuche passende Version zu finden
          for VERSION in "${STABLE_VERSIONS[@]}"; do
            TEST_URL="https://storage.googleapis.com/chrome-for-testing-public/$VERSION/linux64/chromedriver-linux64.zip"
            echo "Teste Version: $VERSION"
            
            if curl --output /dev/null --silent --head --fail "$TEST_URL"; then
              CHROMEDRIVER_URL="$TEST_URL"
              echo "✅ Gefundene ChromeDriver-Version: $VERSION"
              break
            fi
          done
          
          # Fallback auf neueste bekannte Version
          if [ -z "$CHROMEDRIVER_URL" ]; then
            CHROMEDRIVER_URL="https://storage.googleapis.com/chrome-for-testing-public/129.0.6668.70/linux64/chromedriver-linux64.zip"
            echo "⚠️ Verwende Fallback-Version"
          fi
          
          echo "ChromeDriver URL: $CHROMEDRIVER_URL"
          
          # ChromeDriver herunterladen und installieren
          wget -O /tmp/chromedriver.zip "$CHROMEDRIVER_URL"
          cd /tmp
          unzip chromedriver.zip
          
          # Den tatsächlichen chromedriver finden (kann in Unterordner sein)
          CHROMEDRIVER_BINARY=$(find /tmp -name "chromedriver" -type f -executable | head -1)
          
          if [ -z "$CHROMEDRIVER_BINARY" ]; then
            echo "❌ ChromeDriver binary nicht gefunden, zeige Inhalt:"
            find /tmp -name "*chrome*" -type f
            exit 1
          fi
          
          echo "Gefundener ChromeDriver: $CHROMEDRIVER_BINARY"
          
          # Installieren
          sudo cp "$CHROMEDRIVER_BINARY" /usr/local/bin/chromedriver
          sudo chmod +x /usr/local/bin/chromedriver
          
          # Überprüfen
          chromedriver --version
          which chromedriver
      
      # Bot mit erweiterten Umgebungsvariablen ausführen
      - name: Run bot
        run: |
          # Virtual display für Headless-Chrome
          export DISPLAY=:99
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          
          # Chrome-Optionen setzen
          export CHROME_BIN=/usr/bin/google-chrome
          export CHROMEDRIVER_VERBOSE=1
          
          # Bot ausführen mit Timeout
          timeout 12m python bot.py || echo "Bot-Timeout erreicht"
        env:
          BLUESKY_HANDLE: ${{ secrets.BLUESKY_HANDLE }}
          BLUESKY_PASSWORD: ${{ secrets.BLUESKY_PASSWORD }}
          # Logging-Level setzen
          PYTHONUNBUFFERED: 1
          # Chrome-spezifische Umgebungsvariablen
          CHROME_LOG_FILE: /tmp/chrome.log
      
      # Log-Output für Debugging (bei Fehlern)
      - name: Show logs on failure
        if: failure()
        run: |
          echo "=== Chrome Logs ==="
          cat /tmp/chrome.log 2>/dev/null || echo "Keine Chrome-Logs verfügbar"
          echo "=== System Info ==="
          df -h
          free -m
          ps aux | grep chrome | head -10
      
      # Aktualisierte data.json committen und pushen
      - name: Commit and push updated state
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Nur committen wenn sich data.json geändert hat
          if git diff --quiet data.json; then
            echo "Keine Änderungen in data.json"
          else
            echo "Änderungen in data.json gefunden, committe..."
            git add data.json
            
            # Auch Backup-Datei hinzufügen falls vorhanden
            if [ -f data_backup.json ]; then
              git add data_backup.json
            fi
            
            # Commit mit detaillierterer Nachricht
            TIMESTAMP=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
            git commit -m "Update state file - $TIMESTAMP [skip ci]"
            
            # Push mit Retry-Logic
            for i in {1..3}; do
              if git push origin HEAD:main; then
                echo "✅ Push erfolgreich (Versuch $i)"
                break
              else
                echo "❌ Push fehlgeschlagen (Versuch $i), warte 5 Sekunden..."
                sleep 5
              fi
            done
          fi
      
      # Cleanup (optional, für bessere Performance)
      - name: Cleanup
        if: always()
        run: |
          # Chrome-Prozesse beenden
          pkill -f chrome || true
          pkill -f Xvfb || true
          
          # Temporäre Dateien löschen
          rm -rf /tmp/.org.chromium.Chromium.* 2>/dev/null || true
          rm -f /tmp/chrome.log 2>/dev/null || true
